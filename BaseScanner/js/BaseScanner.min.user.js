// ==UserScript==
// @name        BaseScanner
// @version     2020.01.19
// @author      leo7044 (https://github.com/leo7044)
// @homepage    https://cnc.indyserver.info/BaseScanner/
// @downloadURL https://cnc.indyserver.info/BaseScanner/js/BaseScanner.min.user.js
// @updateURL   https://cnc.indyserver.info/BaseScanner/js/BaseScanner.min.user.js
// @require		https://code.jquery.com/jquery-3.3.1.min.js
// @description BaseScanner
// @include     https://cncapp*.alliances.commandandconquer.com/*/index.aspx*
// @grant       none
// ==/UserScript==

!function(){var e,t=function(){function e(){var e=[],t=[];function a(){attRange=ClientLib.Data.MainData.GetInstance().get_Server().get_MaxAttackDistance(),ArrayPrototypeGameObjectType2=[],ArrayPrototypeGameObjectType3=[],ArrayIdsForScan=[],errorCounter=0}function n(){for(var e=new Array(8).fill().map(e=>new Array(9).fill()),t=ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentCity(),a=0;a<8;a++)for(var n=0;n<9;n++)t.GetResourceType(n,a)&&(e[a][n]=t.GetResourceType(n,a));var r=t.get_X(),i=t.get_Y(),o=0,s=0,c=0,l=0,u=0,g=0,p=0,f=0,b=0,y=0,d=0,C=0,h=0,I=0,S=0,_=0,D=0,v=0,m=0,A=0,G=0,k=0,L=0,B=0,M=0;for(a=0;a<8;a++)for(n=0;n<9;n++)if(null==e[a][n]){var O=0,F=0,T=0,P=0;switch(0==n&&0==a?(1==e[a][n+1]?(F++,T++):2==e[a][n+1]?(O++,T++):P++,1==e[a+1][n+1]?(F++,T++):2==e[a+1][n+1]?(O++,T++):P++,1==e[a+1][n]?(F++,T++):2==e[a+1][n]?(O++,T++):P++):8==n&&0==a?(1==e[a][n-1]?(F++,T++):2==e[a][n-1]?(O++,T++):P++,1==e[a+1][n-1]?(F++,T++):2==e[a+1][n-1]?(O++,T++):P++,1==e[a+1][n]?(F++,T++):2==e[a+1][n]?(O++,T++):P++):0==a?(1==e[a][n-1]?(F++,T++):2==e[a][n-1]?(O++,T++):P++,1==e[a+1][n-1]?(F++,T++):2==e[a+1][n-1]?(O++,T++):P++,1==e[a+1][n]?(F++,T++):2==e[a+1][n]?(O++,T++):P++,1==e[a+1][n+1]?(F++,T++):2==e[a+1][n+1]?(O++,T++):P++,1==e[a][n+1]?(F++,T++):2==e[a][n+1]?(O++,T++):P++):0==n&&7==a?(1==e[a-1][n]?(F++,T++):2==e[a-1][n]?(O++,T++):P++,1==e[a-1][n+1]?(F++,T++):2==e[a-1][n+1]?(O++,T++):P++,1==e[a][n+1]?(F++,T++):2==e[a][n+1]?(O++,T++):P++):0==n?(1==e[a-1][n]?(F++,T++):2==e[a-1][n]?(O++,T++):P++,1==e[a-1][n+1]?(F++,T++):2==e[a-1][n+1]?(O++,T++):P++,1==e[a][n+1]?(F++,T++):2==e[a][n+1]?(O++,T++):P++,1==e[a+1][n+1]?(F++,T++):2==e[a+1][n+1]?(O++,T++):P++,1==e[a+1][n]?(F++,T++):2==e[a+1][n]?(O++,T++):P++):8==n&&7==a?(1==e[a][n-1]?(F++,T++):2==e[a][n-1]?(O++,T++):P++,1==e[a-1][n-1]?(F++,T++):2==e[a-1][n-1]?(O++,T++):P++,1==e[a-1][n]?(F++,T++):2==e[a-1][n]?(O++,T++):P++):7==a?(1==e[a][n-1]?(F++,T++):2==e[a][n-1]?(O++,T++):P++,1==e[a-1][n-1]?(F++,T++):2==e[a-1][n-1]?(O++,T++):P++,1==e[a-1][n]?(F++,T++):2==e[a-1][n]?(O++,T++):P++,1==e[a-1][n+1]?(F++,T++):2==e[a-1][n+1]?(O++,T++):P++,1==e[a][n+1]?(F++,T++):2==e[a][n+1]?(O++,T++):P++):8==n?(1==e[a-1][n]?(F++,T++):2==e[a-1][n]?(O++,T++):P++,1==e[a-1][n-1]?(F++,T++):2==e[a-1][n-1]?(O++,T++):P++,1==e[a][n-1]?(F++,T++):2==e[a][n-1]?(O++,T++):P++,1==e[a+1][n-1]?(F++,T++):2==e[a+1][n-1]?(O++,T++):P++,1==e[a+1][n]?(F++,T++):2==e[a+1][n]?(O++,T++):P++):(1==e[a-1][n]?(F++,T++):2==e[a-1][n]?(O++,T++):P++,1==e[a-1][n+1]?(F++,T++):2==e[a-1][n+1]?(O++,T++):P++,1==e[a][n+1]?(F++,T++):2==e[a][n+1]?(O++,T++):P++,1==e[a+1][n+1]?(F++,T++):2==e[a+1][n+1]?(O++,T++):P++,1==e[a+1][n]?(F++,T++):2==e[a+1][n]?(O++,T++):P++,1==e[a+1][n-1]?(F++,T++):2==e[a+1][n-1]?(O++,T++):P++,1==e[a][n-1]?(F++,T++):2==e[a][n-1]?(O++,T++):P++,1==e[a-1][n-1]?(F++,T++):2==e[a-1][n-1]?(O++,T++):P++),O){case 6:o++;break;case 5:s++;break;case 4:c++;break;case 3:l++;break;case 2:u++;break;case 1:g++}switch(F){case 6:p++;break;case 5:f++;break;case 4:b++;break;case 3:y++;break;case 2:d++;break;case 1:C++}switch(T){case 6:h++;break;case 5:I++;break;case 4:S++;break;case 3:_++;break;case 2:D++;break;case 1:v++}switch(P){case 8:m++;break;case 7:A++;break;case 6:G++;break;case 5:k++;break;case 4:L++;break;case 3:B++;break;case 2:M++}}return{Zeit:Date.now(),PosX:r,PosY:i,Layout:JSON.stringify(e),EvaluatedFields:[o,s,c,l,u,g,p,f,b,y,d,C,h,I,S,_,D,v,m,A,G,k,L,B,M]}}function r(e){for(var a=ClientLib.Data.MainData.GetInstance().get_Cities().get_AllCities().d[e].get_PosX(),n=ClientLib.Data.MainData.GetInstance().get_Cities().get_AllCities().d[e].get_PosY(),r=parseInt(a-attRange);r<=parseInt(a+attRange);r++)for(var i=parseInt(n-attRange);i<=parseInt(n+attRange);i++){if(Math.sqrt(Math.pow(r-a,2)+Math.pow(i-n,2))<=attRange){var o=ClientLib.Data.MainData.GetInstance().get_World().GetObjectFromPosition(r,i);if(o)if(3==o.Type&&(o[ArrayPrototypeGameObjectType3[10]]>0||o[ArrayPrototypeGameObjectType3[11]]>0)){var s=o[ArrayPrototypeGameObjectType3[12]];-1==ArrayIdsForScan.indexOf(s)&&-1==t.indexOf(s)&&ArrayIdsForScan.push(s)}else if(2==o.Type){s=o[ArrayPrototypeGameObjectType2[12]];-1==ArrayIdsForScan.indexOf(s)&&-1==t.indexOf(s)&&ArrayIdsForScan.push(s)}}}}qx.Class.define("BaseScanner",{type:"singleton",extend:qx.core.Object,construct:function(){console.log("create BaseScanner...")},members:{initialize:function(){this.ScriptIsRunning=!1,this.buttonBaseScanner=new qx.ui.form.Button("Start BaseScanner...").set({center:!0,rich:!0}),this.buttonBaseScanner.addListener("click",function(){this.ScriptIsRunning?this.stopBaseScan():this.startBaseScan()},this),this.app=qx.core.Init.getApplication(),this.app.getDesktop().add(this.buttonBaseScanner,{right:125,top:0})},startBaseScan:function(){this.ScriptIsRunning=!0,this.buttonBaseScanner.setLabel("Stop BaseScanner..."),console.log("Start..."),a(),function(){var e=ClientLib.Data.MainData.GetInstance().get_Cities().get_AllCities().d;for(var t in e){for(var a=e[t].get_X(),n=e[t].get_Y(),r=0,i=0,o=0,s=0,c=a-10;c<a+10;c++){for(var l=n-10;l<n+10;l++){var u=ClientLib.Data.MainData.GetInstance().get_World().GetObjectFromPosition(c,l);if(null!=u)if(2!=u.Type||r||i)if(3!=u.Type||o||s){if(r&&i&&o&&s)break}else o=c,s=l;else r=c,i=l}if(r&&i&&o&&s)break}if(r&&i&&o&&s)break}for(var t in ClientLib.Data.MainData.GetInstance().get_World().GetObjectFromPosition(r,i))ArrayPrototypeGameObjectType2.push(t);for(var t in ClientLib.Data.MainData.GetInstance().get_World().GetObjectFromPosition(o,s))ArrayPrototypeGameObjectType3.push(t)}(),function(){var e=ClientLib.Data.MainData.GetInstance().get_Cities().get_AllCities().d;for(var t in e){var a=e[t],n=a.get_Id();r(n)}}(),function a(){for(var r in ArrayIdsForScan){var i=ArrayIdsForScan[r];ClientLib.Data.MainData.GetInstance().get_Cities().set_CurrentCityId(i),setTimeout(function(){ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentCity()?ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentCity().get_Buildings().c&&ClientLib.Data.MainData.GetInstance().get_Cities().get_CurrentCity().get_OwnerId()<0?(errorCounter=0,e.push(n()),t.push(i),ArrayIdsForScan.splice(0,1),console.log(e.length+" / "+ArrayIdsForScan.length),BaseScanner.getInstance().setLabel(e.length,e.length+ArrayIdsForScan.length),a()):errorCounter<5?(errorCounter++,console.log("Layout not found ("+errorCounter+")"),a()):(console.log("Layout not found ("+errorCounter+"), removing it from scan"),ArrayIdsForScan.splice(0,1),errorCounter=0,a()):errorCounter<5?errorCounter+=1:(console.log("Layout not found ("+errorCounter+"), removing it from scan"),ArrayIdsForScan.splice(0,1),errorCounter=0,a())},1e3);break}ArrayIdsForScan.length||(function(){for(var t=ClientLib.Data.MainData.GetInstance().get_Server().get_WorldId(),a=ClientLib.Data.MainData.GetInstance().get_Player().get_Name(),n=0;n<Math.ceil(e.length/30);n++){var r=[];if(n==Math.ceil(e.length/30)-1)for(var i=30*n;i<e.length;i++)r.push(e[i]);else for(var i=30*n;i<30*(n+1);i++)r.push(e[i]);var o={action:"sendDataFromInGame",ObjectData:r,WorldId:t,PlayerName:a};$.post("https://cnc.indyserver.info/BaseScanner/php/manageBackend.php",o).always(function(e){console.log(e)})}}(),setTimeout(function(){BaseScanner.getInstance().stopBaseScan()},1e3))}()},stopBaseScan:function(){this.ScriptIsRunning=!1,this.buttonBaseScanner.setLabel("Start BaseScanner..."),a()},setLabel:function(e,t){this.buttonBaseScanner.setLabel("Scan Base... ("+e+" / "+t+")")},getArrayLayouts:function(){return e},getArrayScannedIds:function(){return t}}}),BaseScanner.getInstance().initialize()}!function t(){try{if("undefined"!=typeof qx&&qx.core.Init.getApplication().getMenuBar())return void e()}catch(e){void 0!==console?console.log(e):window.opera?opera.postError(e):GM_log(e)}window.setTimeout(t,1e3)}()};(e=document.createElement("script")).innerHTML="("+t.toString()+")();",e.type="text/javascript",document.getElementsByTagName("head")[0].appendChild(e)}();