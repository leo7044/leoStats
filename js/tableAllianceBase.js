/* Developer: leo7044 (https://github.com/leo7044) */

var ObjectCncOptPics =
{ // Link:
    // https://eaassets-a.akamaihd.net/cncalliancesgame/cdn/data/*.png
    // https://up.picr.de/*.png
    "1":
    { // GDI
        "build":
        {
            "a": "bed291af87f3df1debd710bceb93339b",
            "b": "7fffa929ca0e9638af471e7a253a48f0",
            "c": "5425f9b3b2c406e1517d1bf3daaa1b80",
            "d": "5030a7b96710ace8403d93bc4be3cb0a",
            "e": "ff511429bde455769635de5c8c0331ba",
            "f": "63c4221b2884a410478e42ae891c9edf",
            "h": "",
            "i": "8a1f3c4733a038c05390deb2efb254f7",
            "n": "",
            "p": "45ee74e3da3af2cb20d3fa8507dddd77",
            "q": "068e7c9d022c4760d9c14b7caa26b31f",
            "r": "96a293c753b08a31f29cdd75691330d3",
            "s": "a222bf5074076084bb930a242423c324",
            "t": "4bc5605149c6f6330630e31706b2975d",
            "w": "6445fff4b183a735ca5028eeade06dca",
            "x": "48d1286bac495eb7fb1cee71a3c1a172",
            "y": "064f39ada6c95ed8a60c12c0ee53032d",
            "z": "e1cb3016a04055a51378f6bbbee09c06"
        },
        "def":
        {
            "a": "c7747482bc35b977f4bc743f9f0e681f",
            "b": "ac1a3216145582cb122ad0444305744a",
            "c": "cc9b27f83c30256c4541f414d5a5eff9",
            "d": "2efe3af60d7ad225a163338a13934eff",
            "e": "ef3699386f7a1a8a189da12fde642bb5",
            "f": "2ce93c21bf26af3eb040379291acfbe7",
            "g": "004559af92de104d638c5e4187ab2f68",
            "h": "d83af3ba4bd3c3cced272d16a714afeb",
            "k": "b78f10062ea7d5e1b621165bc98f9aba",
            "j": "7ecdf5416e6de57831e8e096e8445392",
            "l": "af0f04fa7c5f45d7fe72cc14049c141f",
            "m": "7ca2faeeb34e0bbe267ef985c5e7d47a",
            "p": "af49b884f9b1bf86f6a74c6dba93f70e",
            "q": "4c58dc7231d3db8bf162669b41471394",
            "r": "bc9190a6a17aa8ea380ccf9c6d56270d",
            "s": "c02ec23b12cdc627f2df0b50c7d1bcdd",
            "t": "ac1a3216145582cb122ad0444305744a",
            "w": "073528f52ec8cabaf5921a0d9a7da2eb",
            "z": "0de460bca1916337a234fc05e9984b28"
        },
        "off":
        {
            "a": "3aec54985dcbf4b45ff84e1289d46a93",
            "c": "9d0c409eb58a5fb8247cf6882fd31bfa",
            "d": "fd4ffe3334d171c8d960d32fc9e05f80",
            "f": "ecceb58e0ca3f150d85cb224bc345b9f",
            "g": "004559af92de104d638c5e4187ab2f68",
            "j": "aa4f4158569b0bd5255b1471f57a8a2c",
            "k": "d96466153f645ba08707553b700869a2",
            "m": "fe4e67d1d787bae0afb88625545f28a2",
            "o": "42842f77387dbf0be9a0da05d09ea2e7",
            "p": "3ca40f1ad54544ca6cc5b8053b09bfa3",
            "q": "4c58dc7231d3db8bf162669b41471394",
            "r": "b1c0d437f5be0deb9d8ec30d064596c5",
            "s": "c02ec23b12cdc627f2df0b50c7d1bcdd",
            "z": "0de460bca1916337a234fc05e9984b28"
        }
    },
    "2":
    { // NOD
        "build":
        {
            "a": "fd45303e6de92356ff2631f0d89b18c6",
            "b": "1f57aad9607fd714d869d56a2dd06f21",
            "c": "5425f9b3b2c406e1517d1bf3daaa1b80",
            "d": "68689144e5d27c3f5bd9be5078bebce8",
            "e": "7b6edd4d58121a564fd702d152f89011",
            "f": "4451b3a877eeee0e5b1c2a7a5d357b7e",
            "h": "",
            "i": "a46088f246aaedde74f7e6c0dd902a7a",
            "n": "",
            "p": "30c77e68b4e50d9633f969835afc84ec",
            "q": "a0f7eaeb290b20f4dcba75289f9ee429",
            "r": "6c8ee0f7603c621bbaef0e4b6563313e",
            "s": "1ab36789d1dfbf749ddf7ffd9b013dbf",
            "t": "4bc5605149c6f6330630e31706b2975d",
            "w": "f6a0bb2a70d8b05e4cb4db827d9050a4",
            "x": "370675edbcf691b67e1ae874e6efb783",
            "y": "1124d44ed88596a9bf3025250665c218",
            "z": "1f06c9c71a46c1902ff6a91dffed99e0"
        },
        "def":
        {
            "a": "97d5f7a66d9baa65453c2b142eeae3a4",
            "b": "c45676344ea89bc56b291fe6216579a2",
            "c": "5393c7f1282d25cba597e13ad634f1f7",
            "d": "b97c04e08be8d479d54b3ca8262b0e2a",
            "e": "5ee5c7b61f713dbde4602c998ed5e473",
            "f": "53a600e31563975d611a7b5049fe9827",
            "g": "ac5b7596bab3d1b919d7ec9d569f3cb4",
            "h": "d83af3ba4bd3c3cced272d16a714afeb",
            "k": "b78f10062ea7d5e1b621165bc98f9aba",
            "j": "7ecdf5416e6de57831e8e096e8445392",
            "l": "af0f04fa7c5f45d7fe72cc14049c141f",
            "m": "d437cd22189d1c676c016de17170d2e9",
            "p": "e022847fb155ce802c1e38a4cc627ee7",
            "q": "939e53aef324e39bb0048b2c3dfb7988",
            "r": "fb872bf7567447e2ca99eb27c67db685",
            "s": "32eacc57fb7197ec96058a39c8d10aa2",
            "t": "0c7e2d6bf5410cd368020bfb5106a84c",
            "w": "7b144c4394665390eff687baad9bd01a",
            "z": "1d76141c36ce7fb5d9b058481e5265fc"
        },
        "off":
        {
            "a": "88cf8ac7cfb2fdddb9f2acf70f22f1c1",
            "b": "e022847fb155ce802c1e38a4cc627ee7",
            "c": "e1e461f40c3611626243a516ac420fdf",
            "k": "ac5b7596bab3d1b919d7ec9d569f3cb4",
            "l": "c95af3da04ac7a0a490090498c90630d",
            "m": "0a5ea3cdf78d1b773fd97e827b34376e",
            "o": "b97c04e08be8d479d54b3ca8262b0e2a",
            "p": "9910093e404ebf00259ac356609a0943",
            "q": "939e53aef324e39bb0048b2c3dfb7988",
            "r": "7836069122aac3e22c5b7fba07761274",
            "s": "32eacc57fb7197ec96058a39c8d10aa2",
            "t": "77316566179c7cab19bb6546f1389deb",
            "v": "2a9522cbdb67b87d96443ec38ee0cdb9",
            "z": "1d76141c36ce7fb5d9b058481e5265fc"
        }
    }
};

function buildTableAllianceBase(_curObjectAllianceBaseData, _type)
{
    var maxBaseCount = 0;
    var curBaseCount = 0;
    var lastName = '';
    for (key in _curObjectAllianceBaseData)
    {
        if (_curObjectAllianceBaseData[key]['UserName'] != lastName)
        {
            curBaseCount = 0;
        }
        lastName = _curObjectAllianceBaseData[key]['UserName'];
        curBaseCount++;
        if (curBaseCount > maxBaseCount)
        {
            maxBaseCount = curBaseCount;
        }
    }
    var strHtml =
        '<th onclick="sortTable(0, \'TableAllianceBase\', \'asc\')" class="own-cursor-pointer">PlayerName</th>' +
        '<th onclick="sortTable(1, \'TableAllianceBase\', \'asc\')" class="own-cursor-pointer">Faction</th>';
    for (var i = 1; i <= maxBaseCount; i++)
    {
        strHtml += '<th style="text-align: center;" onclick="sortTable(' + (i + 1) + ', \'TableAllianceBase\', \'desc\')" class="own-cursor-pointer">Base ' + i + '</th>';
    }
    $('#TableAllianceBaseTheadTr')[0].innerHTML = strHtml;
    lastName = '';
    curBaseCount = 1;
    var maxLvL = alasql('SELECT MAX(' + _type + ') FROM ?',[_curObjectAllianceBaseData])[0]['MAX(' + _type + ')'];
    var ArrayColors =
    [
        '#33CC33', '#44CC33', '#55CC33', '#66CC33', '#77CC33',
        '#88CC33', '#99CC33', '#AACC33', '#BBCC33', '#CCCC33',
        '#CCBB33', '#CCAA33', '#CC9933', '#CC8833', '#CC7733',
        '#CC6633', '#CC5533', '#CC4433', '#CC3333'
    ];
    var curColor = '';
    strHtml = '';
    for (var key in _curObjectAllianceBaseData)
    {
        if (ArrayNotNeeded.indexOf(key) == -1)
        {
            if (_curObjectAllianceBaseData[key]['UserName'] != lastName)
            {
                if (key != 0)
                {
                    while (curBaseCount <= maxBaseCount)
                    {
                        strHtml += '<td></td>';
                        curBaseCount ++;
                    }
                    curBaseCount = 1;
                    strHtml += '</tr><tr>' +
                        '<td>' + _curObjectAllianceBaseData[key]['UserName'] + '</td>' +
                        '<td style="text-align: center;"><img src="img/faction_' + _curObjectAllianceBaseData[key]['Faction'] + '.png" width="20px" height="20px"></td>';
                }
                else
                {
                    strHtml +=
                        '<td>' + _curObjectAllianceBaseData[key]['UserName'] + '</td>' +
                        '<td style="text-align: center;"><img src="img/faction_' + _curObjectAllianceBaseData[key]['Faction'] + '.png" width="20px" height="20px"></td>';
                }
            }
            var procentLvLOff = parseFloat(_curObjectAllianceBaseData[key][_type]) / parseFloat(maxLvL);
            if (procentLvLOff >= 0.99){curColor = ArrayColors[0];}
            else if (procentLvLOff >= 0.98){curColor = ArrayColors[1];}
            else if (procentLvLOff >= 0.97){curColor = ArrayColors[2];}
            else if (procentLvLOff >= 0.96){curColor = ArrayColors[3];}
            else if (procentLvLOff >= 0.95){curColor = ArrayColors[4];}
            else if (procentLvLOff >= 0.94){curColor = ArrayColors[5];}
            else if (procentLvLOff >= 0.93){curColor = ArrayColors[6];}
            else if (procentLvLOff >= 0.92){curColor = ArrayColors[7];}
            else if (procentLvLOff >= 0.91){curColor = ArrayColors[8];}
            else if (procentLvLOff >= 0.90){curColor = ArrayColors[9];}
            else if (procentLvLOff >= 0.80){curColor = ArrayColors[10];}
            else if (procentLvLOff >= 0.70){curColor = ArrayColors[11];}
            else if (procentLvLOff >= 0.60){curColor = ArrayColors[12];}
            else if (procentLvLOff >= 0.50){curColor = ArrayColors[13];}
            else if (procentLvLOff >= 0.40){curColor = ArrayColors[14];}
            else if (procentLvLOff >= 0.30){curColor = ArrayColors[15];}
            else if (procentLvLOff >= 0.20){curColor = ArrayColors[16];}
            else if (procentLvLOff >= 0.10){curColor = ArrayColors[17];}
            else if (procentLvLOff >= 0.00){curColor = ArrayColors[18];}
            else {curColor = '';}
            strHtml += '<td style="text-align: right; background-color: ' + curColor + '; cursor: pointer;" onclick="convertCncOptToArray(\'' + _curObjectAllianceBaseData[key]['CnCOpt'] + '\', \'' + _curObjectAllianceBaseData[key]['UserName'] + '\', ' + curBaseCount + ');">';
            if (_type == 'LvLOff' || _type == 'LvLDef' || _type == 'LvLSup')
            {
                strHtml += _curObjectAllianceBaseData[key][_type] + '</td>';
            }
            else
            {
                strHtml += Intl.NumberFormat('en-US').format(_curObjectAllianceBaseData[key][_type]) + '</td>';
            }
            lastName = _curObjectAllianceBaseData[key]['UserName'];
            curBaseCount++;
            if (key == _curObjectAllianceBaseData.length - 1)
            {
                while (curBaseCount <= maxBaseCount)
                {
                    strHtml += '<td></td>';
                    curBaseCount ++;
                }
            }
        }
    }
    strHtml += '</tr>';
    $('#TableAllianceBaseTbody')[0].innerHTML = strHtml;
    fixOpticTable('TableAllianceBase');
}

function sortTable(_rowId, _tableId, _order)
{
    var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
    table = document.getElementById(_tableId);
    switching = true;
    dir = _order;
    while (switching)
    {
        switching = false;
        rows = table.getElementsByTagName("tr");
        for (i = 1; i < (rows.length - 1); i++)
        {
            shouldSwitch = false;
            x = rows[i].getElementsByTagName("td")[_rowId];
            y = rows[i + 1].getElementsByTagName("td")[_rowId];
			if (isNaN(parseInt(x.innerHTML)) == false && isNaN(parseInt(y.innerHTML)) == false)
			{
				if (dir == "desc")
				{
					if (parseInt(x.innerHTML.replace(/,|\./g, '')) < parseInt(y.innerHTML.replace(/,|\./g, '')))
					{
						shouldSwitch= true;
						break;
					}
				}
				else if (dir == "asc")
				{
					if (parseInt(x.innerHTML.replace(/,|\./g, '')) > parseInt(y.innerHTML.replace(/,|\./g, '')))
					{
						shouldSwitch= true;
						break;
					}
				}
			}
			else
			{
				if (dir == "desc")
				{
					if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase())
					{
						shouldSwitch= true;
						break;
					}
				}
				else if (dir == "asc")
				{
					if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase())
					{
						shouldSwitch= true;
						break;
					}
				}
			}
        }
        if (shouldSwitch)
        {
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
            switchcount ++; 
        }
        else
        {
            if (switchcount == 0 && dir == "desc")
            {
                dir = "asc";
                switching = true;
            }
            else if (switchcount == 0 && dir == "asc")
            {
                dir = "desc";
                switching = true;
            }
            if (rows.length == 2)
            {
                break;
            }
        }
    }
}

function convertCncOptToArray(_strCncOpt, _UserName, _curBaseCount)
{
    var arrayCncOpt = _strCncOpt.split('|');
    var faction = arrayCncOpt[1];
    switch (faction)
    {
        case 'G':
        {
            faction = 1;
            break;
        }
        case 'N':
        {
            faction = 2;
            break;
        }
        default:
        {
            faction = 0;
            break;
        }
    }
    var strBuildings = arrayCncOpt[4];
    var arrayBuildings = $.grep(strBuildings.replace(/\./g, "|.|").replace(/([a-z])/g, function(n){return n + '|'}).replace(/\|\|/g, '|').split('|'), function(n){return n;});
    var x = 0;
    var y = 0;
    var arrayBase = [[]];
    for (var key in arrayBuildings)
    {
        if (ArrayNotNeeded.indexOf(key) == -1)
        {
            arrayBase[y][x] = arrayBuildings[key].replace(/[a-z|\.]/g, function(n){return '|' + n}).split('|');
            x++;
            if (x % 9 == 0)
            {
                x = 0;
                y++;
                if (key != arrayBuildings.length - 1)
                {
                    arrayBase[y] = [];
                }
            }
        }
    }
    $('#HeaderCnCOptLink')[0].innerHTML = '<a href="' + _strCncOpt + '" target="_blank">CnCOpt (' + _UserName + ', Base ' + _curBaseCount + ')</a>';
    convertCncOptArrayToHtml(arrayBase, faction);
}

function convertCncOptArrayToHtml(_arrayBase, _faction)
{
    var array_typeName = ['Build', 'Def', 'Off'];
    var array_typeLength = [8, 8, 4];
    for (var i = 0; i < 3; i++)
    {
        var strHtml = '';
        var startY = 8 * i;
        for (var y = startY; y < (startY + array_typeLength[i]); y++)
        {
            strHtml += '<tr>';
            for (var x = 0; x < 9; x++)
            {
                if (_arrayBase[y][x][1] != '.')
                {
                    if (_arrayBase[y][x][1] != 'h' && _arrayBase[y][x][1] != 'n')
                    {
                        strHtml += '<td><img src="https://eaassets-a.akamaihd.net/cncalliancesgame/cdn/data/' + ObjectCncOptPics[_faction][array_typeName[i].toLowerCase()][_arrayBase[y][x][1]] + '.png" width="30px" height="30px" title="' + _arrayBase[y][x][0] + '"></td>';
                    }
                    else
                    {
                        strHtml += '<td><img src="img/game/faction_' + _faction + '/' + array_typeName[i].toLowerCase() + '/' + _arrayBase[y][x][1] + '.png" width="30px" height="30px" title="' + _arrayBase[y][x][0] + '"></td>';
                    }
                }
                else
                {
                    strHtml += '<td><div style="width: 30px; height: 30px;"></div></td>';
                }
            }
            strHtml += '</tr>';
        }
        $('#TableAllianceBase' + array_typeName[i] + 'CnCOptTbody')[0].innerHTML = strHtml;
        fixOpticTable('TableAllianceBase' + array_typeName[i] + 'CnCOpt');
    }
}

function fixOpticTable(_tableId)
{
    $('#' + _tableId).css('border', '1px outset rgb(128, 128, 128)');
    for (var i = 0; i < $('#' + _tableId).children('thead').children('tr').children('th').length; i++)
    {
        $($('#' + _tableId).children('thead').children('tr').children('th')[i]).css('border', '1px inset rgb(128, 128, 128)');
        $($('#' + _tableId).children('thead').children('tr').children('th')[i]).css('vertical-align', 'middle');
    }
    for (var i = 0; i < $('#' + _tableId).children('tbody').children('tr').length; i++)
    {
        for (var j = 0; j < $($('#' + _tableId).children('tbody').children('tr')[i]).children('td').length; j++)
        {
            $($($('#' + _tableId).children('tbody').children('tr')[i]).children('td')[j]).css('border', '1px inset rgb(128, 128, 128)');
            $($($('#' + _tableId).children('tbody').children('tr')[i]).children('td')[j]).css('vertical-align', 'middle');
        }
    }
}